---
title: "DEseq2 - multivariate analysis"
output: 
---

Installing basic dependencies:
```{r}
install_if_missing <- function(packages) {
    if (length(setdiff(packages, rownames(installed.packages()))) > 0) {
        install.packages(setdiff(packages, rownames(installed.packages())))
    }
}
```

```{r}
install_if_missing(c('tidyverse','stringr','dplyr', 'edgeR', 'ggrepel','DESeq2','Seurat'))
```

```{r}
library(tidyverse)
library(DESeq2)
library(dplyr)
```

Analysing sparse matrices created above
```{r}
knitr::opts_chunk$set(echo = TRUE)
    library(tidyverse)
    library(Seurat)
```
PW dir= '/Users/akhorgad/mdl-docs-external/test_data'

Input counts matrix created above from step1:
```{r}
data_dir = "/Users/akhorgad/mdl-docs-external/test_data/scIsoquantMatrixBuilder_Results/PBMC_BioIVT_10x3p.genes-sc_matrix_from_isoquant/"
output_prefix = "scKinnex.genes"
```
Reading data in using Read10x() :
```{r}
data = Read10X(data.dir=data_dir,
           gene.column = 1,
           cell.column = 2,
           unique.features = TRUE,
           strip.suffix = FALSE)
```
Creating seurat object from counts matrix:
```{r}
seurat_obj <- CreateSeuratObject(counts = data, project = "scKinnex", min.cells = 3, min.features = 200)
seurat_obj
```
Terminal Out:
Warning: Feature names cannot have underscores ('_'), replacing with dashes ('-')An object of class Seurat 
3853 features across 274 samples within 1 assay 
Active assay: RNA (3853 features, 0 variable features)
 1 layer present: counts
 
```{r}
# before filtering
seurat_obj@meta.data %>% summarize(median(nCount_RNA), median(nFeature_RNA))
```
Terminal Out:

median(nCount_RNA)        median(nFeature_RNA)
<dbl>                     <dbl>              
309.4                   	204	

Filtering on UMI counts:
```{r}
UMI_count_high = 15000
UMI_count_low = 1500


seurat_obj@meta.data %>% select(nCount_RNA) %>% arrange(desc(nCount_RNA)) %>% mutate(i=row_number()) %>%
ggplot(aes(x=i, y=nCount_RNA)) + geom_point() + theme_bw() + scale_y_continuous(trans='log10') +
ggtitle("nCount_RNA: UMI counts per cell") +

geom_hline(yintercept=UMI_count_high) +
geom_hline(yintercept=UMI_count_low)
```

Filtering on feature counts:
```{r}
feature_count_high = 2000
feature_count_low = 300


seurat_obj@meta.data %>% select(nFeature_RNA) %>% arrange(desc(nFeature_RNA)) %>% mutate(i=row_number()) %>%
ggplot(aes(x=i, y=nFeature_RNA)) + geom_point() + theme_bw() + scale_y_continuous(trans='log10') +
ggtitle("nFeature_RNA: gene count per cell") +

geom_hline(yintercept=feature_count_high) +
geom_hline(yintercept=feature_count_low)
```
```{r}
seurat_obj[["percent.mt"]] <- PercentageFeatureSet(seurat_obj, pattern = "^MT-")
```


# Visualize QC metrics as a violin plot
```{r}

VlnPlot(seurat_obj, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
```
```{r}
plot1 <- FeatureScatter(seurat_obj, feature1 = "nCount_RNA", feature2 = "percent.mt")
plot2 <- FeatureScatter(seurat_obj, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
plot1 + plot2
```
NormalizeData 
```{r}
seurat_obj <- NormalizeData(seurat_obj, normalization.method = "LogNormalize", scale.factor = 10000)
```

